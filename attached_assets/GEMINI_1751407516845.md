# GEMINI.md - Ambon Gercep Full Stack Application

## Project Overview

Build a comprehensive service-on-demand platform called "Ambon Gercep" - a WhatsApp-based booking system for car wash, motorcycle wash, and lawn mowing services with AI-powered customer service, real-time tracking, and multi-role management dashboard.

## Tech Stack Requirements

```
Frontend:
- Next.js 14 with App Router
- TypeScript
- Tailwind CSS
- Shadcn/ui components
- React Query for data fetching
- Socket.io-client for real-time updates
- React Hook Form with Zod validation
- Recharts for analytics
- Google Maps React API

Backend:
- Next.js API Routes
- Firebase (Auth, Firestore, Cloud Functions, Storage)
- Twilio for WhatsApp Business API
- Google Gemini API for AI assistant
- Redis for caching and session management
- Node.js scheduled jobs (node-cron)

Integrations:
- Payment Gateway: Xendit (support QRIS, Transfer, E-Wallet, Credit Card)
- Google Maps API for geocoding and routing
- WhatsApp Business API with verified green checkmark
- SMS Gateway for OTP
- Push Notifications via FCM
```

## Database Schema

```typescript
// Users Collection
interface User {
  id: string;
  phoneNumber: string;
  googleId?: string;
  name: string;
  email?: string;
  role: 'customer' | 'worker' | 'admin_umum' | 'admin_perusahaan';
  avatar?: string;
  membershipStatus: {
    level: 'regular' | 'silver' | 'gold';
    orderCount: number;
    totalSpent: number;
    freeServiceAvailable: boolean;
    firstOrderDiscount: boolean;
    joinDate: Timestamp;
  };
  addresses: Array<{
    id: string;
    label: string;
    address: string;
    coordinates: { lat: number; lng: number };
    details?: string;
    isDefault: boolean;
  }>;
  preferences: {
    notificationEnabled: boolean;
    whatsappEnabled: boolean;
    language: 'id' | 'en';
    favoriteServices: string[];
  };
  createdAt: Timestamp;
  updatedAt: Timestamp;
}

// Orders Collection
interface Order {
  id: string;
  trackingId: string; // Format: AGC-XXXYYY
  customerId: string;
  customerInfo: {
    name: string;
    phone: string;
    address: string;
    coordinates: { lat: number; lng: number };
  };
  workerId?: string;
  workerInfo?: {
    name: string;
    phone: string;
    avatar?: string;
    rating: number;
  };
  service: {
    type: 'cuci_motor' | 'cuci_mobil' | 'potong_rumput';
    category: string;
    name: string;
    details: {
      // For vehicles
      plateNumber?: string;
      vehicleType?: string;
      vehicleBrand?: string;
      vehicleColor?: string;
      
      // For lawn mowing
      areaSize?: number;
      houseType?: 'small' | 'medium' | 'large';
      grassHeight?: 'low' | 'medium' | 'high';
      photos?: string[];
      additionalNotes?: string;
    };
  };
  scheduledTime: Timestamp;
  estimatedDuration: number; // in minutes
  priority: 'normal' | 'express' | 'urgent';
  status: 'pending' | 'confirmed' | 'assigned' | 'ontheway' | 'arrived' | 'inprogress' | 'completed' | 'cancelled';
  payment: {
    method: 'cash' | 'qris' | 'transfer' | 'ewallet' | 'cc';
    status: 'pending' | 'processing' | 'paid' | 'failed' | 'refunded';
    amount: number;
    basePrice: number;
    promoCode?: string;
    discount: number;
    serviceFee: number;
    finalAmount: number;
    transactionId?: string;
    paidAt?: Timestamp;
  };
  rating: {
    fromCustomer?: {
      score: number;
      comment?: string;
      ratedAt: Timestamp;
    };
    fromWorker?: {
      score: number;
      comment?: string;
      tags?: string[]; // ['friendly', 'punctual', 'clean_area']
      ratedAt: Timestamp;
    };
  };
  chat: {
    enabled: boolean;
    messages: Array<{
      sender: 'customer' | 'worker' | 'system';
      message: string;
      timestamp: Timestamp;
    }>;
  };
  timeline: Array<{
    status: string;
    timestamp: Timestamp;
    note?: string;
    location?: { lat: number; lng: number };
  }>;
  cancellation?: {
    reason: string;
    cancelledBy: 'customer' | 'worker' | 'system';
    cancelledAt: Timestamp;
    refundAmount?: number;
  };
  createdAt: Timestamp;
  updatedAt: Timestamp;
}

// Workers Collection
interface Worker {
  id: string;
  userId: string;
  employeeId: string;
  personalInfo: {
    name: string;
    phone: string;
    email?: string;
    address: string;
    emergencyContact: {
      name: string;
      phone: string;
      relationship: string;
    };
  };
  specializations: Array<'cuci_motor' | 'cuci_mobil' | 'potong_rumput'>;
  availability: {
    status: 'available' | 'busy' | 'offline' | 'on_leave';
    schedule: Array<{
      dayOfWeek: number; // 0-6
      shifts: Array<{
        start: string; // "08:00"
        end: string; // "17:00"
      }>;
    }>;
    currentLocation?: { 
      lat: number; 
      lng: number; 
      lastUpdated: Timestamp;
    };
    nextAvailable?: Timestamp;
  };
  stats: {
    totalOrders: number;
    completedOrders: number;
    cancelledOrders: number;
    averageRating: number;
    totalRatings: number;
    completionRate: number;
    averageCompletionTime: number;
    monthlyEarnings: number;
    lifetimeEarnings: number;
  };
  documents: {
    ktp?: { url: string; verified: boolean; };
    sim?: { url: string; verified: boolean; };
    npwp?: { url: string; verified: boolean; };
    bankAccount?: {
      bankName: string;
      accountNumber: string;
      accountName: string;
    };
  };
  equipment: {
    hasVehicle: boolean;
    vehicleType?: string;
    hasTools: boolean;
    toolsList?: string[];
  };
  performance: {
    punctualityScore: number;
    qualityScore: number;
    customerSatisfaction: number;
    warnings: number;
    achievements: string[];
  };
  createdAt: Timestamp;
  updatedAt: Timestamp;
}

// Services Collection
interface Service {
  id: string;
  category: 'cuci_motor' | 'cuci_mobil' | 'potong_rumput';
  name: string;
  description: string;
  basePrice: number;
  priceRange: {
    min: number;
    max: number;
  };
  duration: number; // estimated minutes
  requirements?: string[];
  includes: string[];
  addOns?: Array<{
    id: string;
    name: string;
    price: number;
  }>;
  images: string[];
  isActive: boolean;
  popularityScore: number;
  createdAt: Timestamp;
}

// Promotions Collection
interface Promotion {
  id: string;
  code: string;
  name: string;
  description: string;
  type: 'percentage' | 'fixed' | 'free_service';
  value: number;
  conditions: {
    minOrder?: number;
    maxDiscount?: number;
    applicableServices?: string[];
    customerType?: 'new' | 'returning' | 'all';
    usageLimit?: number;
    userLimit?: number;
  };
  validFrom: Timestamp;
  validUntil: Timestamp;
  isActive: boolean;
  usageCount: number;
}

// Conversations Collection (AI Chat History)
interface Conversation {
  id: string;
  customerId: string;
  phoneNumber: string;
  channel: 'whatsapp' | 'web' | 'app';
  status: 'active' | 'resolved' | 'escalated';
  assignedAgent?: string;
  messages: Array<{
    id: string;
    sender: 'customer' | 'ai' | 'agent' | 'system';
    content: string;
    timestamp: Timestamp;
    metadata?: {
      intent?: string;
      confidence?: number;
      actions?: string[];
    };
  }>;
  context: {
    lastIntent?: string;
    stage?: string;
    pendingOrder?: any;
    extractedData?: any;
  };
  escalationReason?: string;
  resolution?: string;
  createdAt: Timestamp;
  updatedAt: Timestamp;
}
```

## Core Features Implementation

### 1. Multi-Channel Authentication System
- Phone number + OTP login (WhatsApp & SMS)
- Google OAuth integration
- Role-based access control (Customer, Worker, Admin Umum, Admin Perusahaan)
- Session management with Redis
- Auto-create user profile on first login

### 2. AI-Powered WhatsApp Integration
```
Features:
- Gemini AI chatbot for natural conversation
- Auto-detect intent (booking, pricing, schedule, complaint)
- Smart context management
- Seamless handover to human CS
- Interactive buttons and quick replies
- Multi-language support (Bahasa & English)

AI Capabilities:
- Understand casual/slang Indonesian
- Extract booking details from natural language
- Check worker availability in real-time
- Apply best promotional offers automatically
- Schedule optimization suggestions
- Complaint classification and routing
```

### 3. Booking System
```
Customer Flow:
1. WhatsApp/Web/App initiation
2. Service selection (with photos for lawn mowing)
3. Location selection (GPS/saved addresses)
4. Schedule selection (now/later/recurring)
5. Worker auto-assignment
6. Price calculation with promos
7. Payment method selection
8. Order confirmation
9. Real-time tracking
10. Two-way rating

Special Features:
- Smart worker assignment based on distance, rating, workload
- Dynamic pricing (surge, distance, time-based)
- Recurring booking for regular customers
- Group booking for multiple services
```

### 4. Real-Time Tracking System
```
Components:
- Live worker location on map
- Customer can see worker approaching
- ETA calculation with traffic
- Route optimization
- Arrival notifications
- In-app chat between customer-worker
- Status updates at each stage
```

### 5. Payment Integration
```
Supported Methods:
- Cash on Delivery
- QRIS (dynamic QR generation)
- Bank Transfer (Virtual Account)
- E-Wallets (GoPay, OVO, Dana, etc.)
- Credit/Debit Cards

Features:
- Invoice generation
- Payment reminders
- Refund processing
- Payment proof upload
- Automatic reconciliation
```

### 6. Membership & Promotions
```
Membership Tiers:
- Regular: Basic benefits
- Silver: After 10 orders (10% discount)
- Gold: After 25 orders (15% discount + priority)

Automated Promotions:
- First-time customer: 30% off
- Every 5th order: Free service
- Birthday month: 20% off
- Referral program: Both get 15% off
- Seasonal campaigns
- Area-based promotions
```

### 7. Admin Dashboard Features

#### Admin Perusahaan (Owner)
```
- Financial analytics and reports
- Revenue vs operational costs
- Profit margins by service
- Customer lifetime value
- Market insights and trends
- Worker performance metrics
- Strategic planning tools
- Export reports (PDF/Excel)
```

#### Admin Umum (Operator)
```
- Order management kanban board
- Real-time order tracking map
- Worker assignment and scheduling
- Customer service tickets
- Daily operation metrics
- Quick actions for common tasks
- Broadcast messaging
```

#### Worker Dashboard
```
- Personal schedule calendar
- Today's tasks with navigation
- Earnings tracker
- Performance metrics
- Equipment checklist
- Leave management
- In-app communication
```

### 8. CRM & Communication
```
Features:
- Customer segmentation
- Automated campaigns
- Birthday/anniversary greetings
- Re-engagement campaigns
- Service reminders
- Broadcast with rate limiting
- Template message management
- Campaign analytics
```

### 9. Smart Scheduling
```
- AI-powered time slot suggestions
- Consider traffic patterns
- Worker skill matching
- Route optimization for multiple orders
- Automatic rescheduling options
- Calendar integration
- Recurring schedule management
```

### 10. Rating & Feedback System
```
Customer rates:
- Service quality (1-5 stars)
- Worker professionalism
- Punctuality
- Value for money
- Written review

Worker rates:
- Customer cooperation
- Location accessibility
- Payment promptness
- Special tags
```

## UI/UX Requirements

### Design System
```
Colors:
- Primary: Teal (#14b8a6)
- Secondary: Slate (#64748b)
- Success: Green (#16a34a)
- Warning: Orange (#f59e0b)
- Error: Red (#dc2626)
- Background: Stone (#f5f5f4)

Typography:
- Font: Inter
- Headings: Bold, various sizes
- Body: Regular, readable sizes
- Mobile-first responsive design
```

### Key Pages/Screens

1. **Landing Page**
   - Hero with CTA
   - Service showcase
   - How it works
   - Testimonials
   - Download app section

2. **Customer App**
   - Home with quick booking
   - Service catalog
   - Booking flow
   - Order tracking
   - Order history
   - Profile & addresses
   - Promotions
   - Help center

3. **Worker App**
   - Today's schedule
   - Task details with navigation
   - Check-in/out
   - Earnings
   - Performance
   - Availability settings

4. **Admin Dashboard**
   - Role-based layouts
   - Real-time metrics
   - Interactive charts
   - Data tables with filters
   - Kanban boards
   - Calendar views
   - Settings

### Mobile Responsiveness
- All interfaces must work on mobile
- Touch-friendly interactions
- Optimized for various screen sizes
- PWA capabilities
- Offline functionality where applicable

## Business Logic Implementation

### Pricing Algorithm
```javascript
function calculatePrice(service, options) {
  let basePrice = service.basePrice;
  
  // Distance surcharge
  if (options.distance > 5) {
    basePrice += (options.distance - 5) * 2000;
  }
  
  // Time-based pricing
  const hour = new Date().getHours();
  if (hour >= 18 || hour < 6) {
    basePrice *= 1.2; // 20% night surcharge
  }
  
  // Demand-based pricing
  if (await checkHighDemand(options.area)) {
    basePrice *= 1.15; // 15% high demand surcharge
  }
  
  // Apply membership discount
  const memberDiscount = getMembershipDiscount(customer.membershipLevel);
  basePrice *= (1 - memberDiscount);
  
  // Apply promo code
  if (options.promoCode) {
    const promo = await validatePromoCode(options.promoCode);
    basePrice = applyPromotion(basePrice, promo);
  }
  
  return Math.round(basePrice);
}
```

### Worker Assignment Algorithm
```javascript
function assignWorker(order) {
  const eligibleWorkers = await getEligibleWorkers({
    service: order.service.type,
    time: order.scheduledTime,
    location: order.location
  });
  
  const scores = eligibleWorkers.map(worker => ({
    worker,
    score: calculateWorkerScore(worker, order)
  }));
  
  return scores.sort((a, b) => b.score - a.score)[0].worker;
}

function calculateWorkerScore(worker, order) {
  let score = 100;
  
  // Distance factor (40% weight)
  const distance = calculateDistance(worker.location, order.location);
  score -= (distance * 2); // -2 points per km
  
  // Rating factor (30% weight)
  score += (worker.stats.averageRating - 3) * 10;
  
  // Workload balance (20% weight)
  const todayOrders = worker.todayOrderCount;
  score -= (todayOrders * 5); // Prefer less busy workers
  
  // Specialization bonus (10% weight)
  if (worker.specializations.includes(order.service.type)) {
    score += 10;
  }
  
  return Math.max(0, score);
}
```

## Security Requirements

1. **API Security**
   - JWT authentication
   - Rate limiting per endpoint
   - Request validation
   - CORS configuration
   - API key management

2. **Data Protection**
   - Encrypt sensitive data (phone, address)
   - HTTPS everywhere
   - Secure file uploads
   - PII data handling compliance

3. **WhatsApp Security**
   - Webhook signature verification
   - Message encryption
   - Secure token storage
   - Session management

4. **Payment Security**
   - PCI compliance
   - Tokenization
   - Fraud detection
   - Secure payment callbacks

## Performance Requirements

1. **Response Times**
   - API responses: < 200ms
   - Page load: < 3s
   - Real-time updates: < 100ms
   - AI responses: < 3s

2. **Scalability**
   - Handle 10,000+ concurrent users
   - 100,000+ daily orders
   - Horizontal scaling ready
   - CDN implementation

3. **Reliability**
   - 99.9% uptime
   - Automatic failover
   - Error monitoring
   - Backup systems

## Monitoring & Analytics

1. **System Monitoring**
   - Server health
   - API performance
   - Error tracking (Sentry)
   - Uptime monitoring

2. **Business Analytics**
   - Order analytics
   - Customer behavior
   - Worker performance
   - Revenue tracking
   - Conversion funnels

3. **AI Performance**
   - Intent recognition accuracy
   - Response quality
   - Handover rate
   - Customer satisfaction

## Deployment Configuration

```yaml
Production Environment:
  - Vercel for Next.js hosting
  - Firebase for backend services
  - Redis Cloud for caching
  - Cloudinary for image storage
  - SendGrid for emails
  
Environment Variables Required:
  - NEXT_PUBLIC_FIREBASE_CONFIG
  - FIREBASE_ADMIN_KEY
  - TWILIO_ACCOUNT_SID
  - TWILIO_AUTH_TOKEN
  - TWILIO_WHATSAPP_NUMBER
  - GEMINI_API_KEY
  - GOOGLE_MAPS_API_KEY
  - XENDIT_API_KEY
  - REDIS_URL
  - JWT_SECRET
  - WEBHOOK_SECRET
```

## Testing Requirements

1. **Unit Tests**
   - Business logic
   - API endpoints
   - Utility functions
   - Components

2. **Integration Tests**
   - Payment flow
   - Booking flow
   - WhatsApp integration
   - AI responses

3. **E2E Tests**
   - Critical user journeys
   - Multi-role scenarios
   - Payment scenarios

## Additional Features

1. **Gamification for Workers**
   - Achievement badges
   - Leaderboards
   - Performance bonuses
   - Milestone rewards

2. **Business Intelligence**
   - Predictive analytics
   - Demand forecasting
   - Route optimization
   - Pricing optimization

3. **Advanced AI Features**
   - Voice note transcription
   - Image recognition for damage reports
   - Sentiment analysis
   - Predictive customer service

## Project Structure

```
ambon-gercep/
├── src/
│   ├── app/
│   │   ├── (auth)/
│   │   ├── (customer)/
│   │   ├── (worker)/
│   │   ├── (admin)/
│   │   ├── api/
│   │   └── layout.tsx
│   ├── components/
│   │   ├── ui/
│   │   ├── features/
│   │   └── layouts/
│   ├── lib/
│   │   ├── firebase/
│   │   ├── gemini/
│   │   ├── twilio/
│   │   ├── payment/
│   │   └── utils/
│   ├── hooks/
│   ├── store/
│   ├── types/
│   └── styles/
├── public/
├── tests/
└── config/
```

## Success Criteria

1. **Technical Success**
   - All features working as specified
   - Performance targets met
   - Security requirements fulfilled
   - 95%+ test coverage

2. **Business Success**
   - 80%+ AI-handled conversations
   - < 2% order failure rate
   - 4.5+ average rating
   - 30% month-over-month growth

3. **User Success**
   - < 3 clicks to book
   - < 30s AI response time
   - 90%+ customer satisfaction
   - 85%+ worker satisfaction

Build this application with production-ready code, following Next.js 14 best practices, with comprehensive error handling, logging, and monitoring. Prioritize user experience, performance, and scalability. Include detailed comments and documentation for all complex logic.